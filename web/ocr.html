<!DOCTYPE html>
<html>
  <head>
    <title>OCR</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <script>
      function makeDispatcher(myAddress, handlers) {
        const pendingRequests = new Map();
        return {
            waitForResponse(requestId) {
                let pending = pendingRequests.get(requestId);
                if (!pending)
                    pendingRequests.set(requestId, pending = makePending());
                return pending.promise;
            },
            dispatch(message, sender, sendResponse) {
                switch (message.type) {
                    case "request": return handleRequest(message, sender, sendResponse);
                    case "notification": return handleNotification(message, sender);
                    case "response": return handleResponse(message);
                }
            },
            updateHandlers(newHandlers) {
                handlers = newHandlers;
            }
        };
        function makePending() {
            const pending = {};
            pending.promise = new Promise((fulfill, reject) => {
                pending.fulfill = fulfill;
                pending.reject = reject;
            });
            return pending;
        }
        function handleRequest(req, sender, sendResponse) {
            if (req.to == myAddress) {
                if (handlers[req.method]) {
                    Promise.resolve()
                        .then(() => handlers[req.method](req.args, sender))
                        .then(result => sendResponse({ to: req.from, type: "response", id: req.id, result, error: undefined }), error => sendResponse({ to: req.from, type: "response", id: req.id, result: undefined, error }));
                    //let caller know that sendResponse will be called asynchronously
                    return true;
                }
                else {
                    console.error("No handler for method", req);
                }
            }
        }
        function handleNotification(ntf, sender) {
            if (ntf.to == myAddress) {
                if (handlers[ntf.method]) {
                    Promise.resolve()
                        .then(() => handlers[ntf.method](ntf.args, sender))
                        .catch(error => console.error("Failed to handle notification", ntf, error));
                }
                else {
                    console.error("No handler for method", ntf);
                }
            }
        }
        function handleResponse(res) {
            const pending = pendingRequests.get(res.id);
            if (pending) {
                pendingRequests.delete(res.id);
                if (res.error)
                    pending.reject(res.error);
                else
                    pending.fulfill(res.result);
            }
            else if (res.to == myAddress) {
                console.error("Stray response", res);
            }
        }
      }

      function memoize(fetch) {
        const map = new Map()
        return function(key) {
          if (map.has(key)) return map.get(key)
          const value = fetch()
          map.set(key, value)
          return value
        }
      }
    </script>

    <script>
      const languageList = [
        {"code":"afr","name":"Afrikaans"},
        {"code":"amh","name":"Amharic"},
        {"code":"ara","name":"Arabic"},
        {"code":"asm","name":"Assamese"},
        {"code":"aze","name":"Azerbaijani"},
        {"code":"aze_cyrl","name":"Azerbaijani - Cyrillic"},
        {"code":"bel","name":"Belarusian"},
        {"code":"ben","name":"Bengali"},
        {"code":"bod","name":"Tibetan"},
        {"code":"bos","name":"Bosnian"},
        {"code":"bul","name":"Bulgarian"},
        {"code":"cat","name":"Catalan; Valencian"},
        {"code":"ceb","name":"Cebuano"},
        {"code":"ces","name":"Czech"},
        {"code":"chi_sim","name":"Chinese - Simplified"},
        {"code":"chi_tra","name":"Chinese - Traditional"},
        {"code":"chr","name":"Cherokee"},
        {"code":"cym","name":"Welsh"},
        {"code":"dan","name":"Danish"},
        {"code":"deu","name":"German"},
        {"code":"dzo","name":"Dzongkha"},
        {"code":"ell","name":"Greek, Modern (1453-)"},
        {"code":"eng","name":"English"},
        {"code":"enm","name":"English, Middle (1100-1500)"},
        {"code":"epo","name":"Esperanto"},
        {"code":"est","name":"Estonian"},
        {"code":"eus","name":"Basque"},
        {"code":"fas","name":"Persian"},
        {"code":"fin","name":"Finnish"},
        {"code":"fra","name":"French"},
        {"code":"frk","name":"German Fraktur"},
        {"code":"frm","name":"French, Middle (ca. 1400-1600)"},
        {"code":"gle","name":"Irish"},
        {"code":"glg","name":"Galician"},
        {"code":"grc","name":"Greek, Ancient (-1453)"},
        {"code":"guj","name":"Gujarati"},
        {"code":"hat","name":"Haitian; Haitian Creole"},
        {"code":"heb","name":"Hebrew"},
        {"code":"hin","name":"Hindi"},
        {"code":"hrv","name":"Croatian"},
        {"code":"hun","name":"Hungarian"},
        {"code":"iku","name":"Inuktitut"},
        {"code":"ind","name":"Indonesian"},
        {"code":"isl","name":"Icelandic"},
        {"code":"ita","name":"Italian"},
        {"code":"ita_old","name":"Italian - Old"},
        {"code":"jav","name":"Javanese"},
        {"code":"jpn","name":"Japanese"},
        {"code":"kan","name":"Kannada"},
        {"code":"kat","name":"Georgian"},
        {"code":"kat_old","name":"Georgian - Old"},
        {"code":"kaz","name":"Kazakh"},
        {"code":"khm","name":"Central Khmer"},
        {"code":"kir","name":"Kirghiz; Kyrgyz"},
        {"code":"kor","name":"Korean"},
        {"code":"kur","name":"Kurdish"},
        {"code":"lao","name":"Lao"},
        {"code":"lat","name":"Latin"},
        {"code":"lav","name":"Latvian"},
        {"code":"lit","name":"Lithuanian"},
        {"code":"mal","name":"Malayalam"},
        {"code":"mar","name":"Marathi"},
        {"code":"mkd","name":"Macedonian"},
        {"code":"mlt","name":"Maltese"},
        {"code":"msa","name":"Malay"},
        {"code":"mya","name":"Burmese"},
        {"code":"nep","name":"Nepali"},
        {"code":"nld","name":"Dutch; Flemish"},
        {"code":"nor","name":"Norwegian"},
        {"code":"ori","name":"Oriya"},
        {"code":"pan","name":"Panjabi; Punjabi"},
        {"code":"pol","name":"Polish"},
        {"code":"por","name":"Portuguese"},
        {"code":"pus","name":"Pushto; Pashto"},
        {"code":"ron","name":"Romanian; Moldavian; Moldovan"},
        {"code":"rus","name":"Russian"},
        {"code":"san","name":"Sanskrit"},
        {"code":"sin","name":"Sinhala; Sinhalese"},
        {"code":"slk","name":"Slovak"},
        {"code":"slv","name":"Slovenian"},
        {"code":"spa","name":"Spanish; Castilian"},
        {"code":"spa_old","name":"Spanish; Castilian - Old"},
        {"code":"sqi","name":"Albanian"},
        {"code":"srp","name":"Serbian"},
        {"code":"srp_latn","name":"Serbian - Latin"},
        {"code":"swa","name":"Swahili"},
        {"code":"swe","name":"Swedish"},
        {"code":"syr","name":"Syriac"},
        {"code":"tam","name":"Tamil"},
        {"code":"tel","name":"Telugu"},
        {"code":"tgk","name":"Tajik"},
        {"code":"tgl","name":"Tagalog"},
        {"code":"tha","name":"Thai"},
        {"code":"tir","name":"Tigrinya"},
        {"code":"tur","name":"Turkish"},
        {"code":"uig","name":"Uighur; Uyghur"},
        {"code":"ukr","name":"Ukrainian"},
        {"code":"urd","name":"Urdu"},
        {"code":"uzb","name":"Uzbek"},
        {"code":"uzb_cyrl","name":"Uzbek - Cyrillic"},
        {"code":"vie","name":"Vietnamese"},
        {"code":"yid","name":"Yiddish"}
      ]
    </script>

    <script>
      const getWorker = memoize(async lang => {
        const worker = await Tesseract.createWorker(lang)
        worker.setParameters({
          tessedit_pageseg_mode: Tesseract.PSM.AUTO_OSD
        })
        return worker
      })

      const dispatcher = makeDispatcher("ocr-service", {
        async recognize({lang, image}) {
          const worker = await getWorker(lang)
          const {data} = await worker.recognize(image)
          return {
            lines: data.lines.map(({baseline, bbox, confidence, text}) => ({baseline, bbox, confidence, text}))
          }
        },
        getLanguageList() {
          return languageList
        }
      })

      addEventListener("message", event => {
        dispatcher.dispatch(event.data, null, res => event.source.postMessage(res, {targetOrigin: event.origin}))
      })

      top.postMessage({
        to: "ocr-host",
        type: "notification",
        method: "onServiceReady"
      }, "*")
    </script>
  </head>
  <body>
  </body>
</html>
